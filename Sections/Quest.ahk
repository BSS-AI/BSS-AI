PolarBear := Map("Aromatic Pie",
	[[3, "Kill", "Mantis"]
		, [4, "Kill", "Ladybugs"]
		, [1, "Collect", "Rose"]
		, [2, "Collect", "Pine Tree"]]
	, "Beetle Brew",
	[[3, "Kill", "Ladybugs"]
		, [4, "Kill", "RhinoBeetles"]
		, [1, "Collect", "Pineapple"]
		, [2, "Collect", "Dandelion"]]
	, "Candied Beetles",
	[[3, "Kill", "RhinoBeetles"]
		, [1, "Collect", "Strawberry"]
		, [2, "Collect", "Blue Flower"]]
	, "Exotic Salad",
	[[1, "Collect", "Cactus"]
		, [2, "Collect", "Rose"]
		, [3, "Collect", "Blue Flower"]
		, [4, "Collect", "Clover"]]
	, "Extreme Stir-Fry",
	[[6, "Kill", "Werewolf"]
		, [5, "Kill", "Scorpions"]
		, [4, "Kill", "Spider"]
		, [1, "Collect", "Cactus"]
		, [2, "Collect", "Bamboo"]
		, [3, "Collect", "Dandelion"]]
	, "High Protein",
	[[4, "Kill", "Spider"]
		, [3, "Kill", "Scorpions"]
		, [2, "Kill", "Mantis"]
		, [1, "Collect", "Sunflower"]]
	, "Ladybug Poppers",
	[[2, "Kill", "Ladybugs"]
		, [1, "Collect", "Blue Flower"]]
	, "Mantis Meatballs",
	[[2, "Kill", "Mantis"]
		, [1, "Collect", "Pine Tree"]]
	, "Prickly Pears",
	[[1, "Collect", "Cactus"]]
	, "Pumpkin Pie",
	[[3, "Kill", "Mantis"]
		, [1, "Collect", "Pumpkin"]
		, [2, "Collect", "Sunflower"]]
	, "Scorpion Salad",
	[[2, "Kill", "Scorpions"]
		, [1, "Collect", "Rose"]]
	, "Spiced Kebab",
	[[3, "Kill", "Werewolf"]
		, [1, "Collect", "Clover"]
		, [2, "Collect", "Bamboo"]]
	, "Spider Pot-Pie",
	[[2, "Kill", "Spider"]
		, [1, "Collect", "Mushroom"]]
	, "Spooky Stew",
	[[4, "Kill", "Werewolf"]
		, [3, "Kill", "Spider"]
		, [1, "Collect", "Spider"]
		, [2, "Collect", "Mushroom"]]
	, "Strawberry Skewers",
	[[3, "Kill", "Scorpions"]
		, [1, "Collect", "Strawberry"]
		, [2, "Collect", "Bamboo"]]
	, "Teriyaki Jerky",
	[[3, "Kill", "Werewolf"]
		, [1, "Collect", "Pineapple"]
		, [2, "Collect", "Spider"]]
	, "Thick Smoothie",
	[[1, "Collect", "Strawberry"]
		, [2, "Collect", "Pumpkin"]]
	, "Trail Mix",
	[[1, "Collect", "Sunflower"]
		, [2, "Collect", "Pineapple"]])


BlackBear := Map("Just White",
	[[1, "Collect", "White"]]
	, "Just Red",
	[[1, "Collect", "Red"]]
	, "Just Blue",
	[[1, "Collect", "Blue"]]
	, "A Bit Of Both",
	[[1, "Collect", "Red"]
		, [2, "Collect", "Blue"]]
	, "Any Pollen",
	[[1, "Collect", "Any"]]
	, "The Whole Lot",
	[[1, "Collect", "Red"]
		, [2, "Collect", "Blue"]
		, [3, "Collect", "White"]]
	, "Between The Bamboo",
	[[2, "Collect", "Bamboo"]
		, [1, "Collect", "Blue"]]
	, "Play In The Pumpkins",
	[[2, "Collect", "Pumpkin"]
		, [1, "Collect", "White"]]
	, "Plundering Pineapples",
	[[2, "Collect", "Pineapple"]
		, [1, "Collect", "Any"]]
	, "Stroll In The Strawberries",
	[[2, "Collect", "Strawberry"]
		, [1, "Collect", "Red"]]
	, "Mid-Level Mission",
	[[1, "Collect", "Spider"]
		, [2, "Collect", "Strawberry"]
		, [3, "Collect", "Bamboo"]]
	, "Blue Flower Bliss",
	[[1, "Collect", "Blue Flower"]]
	, "Delve Into Dandelions",
	[[1, "Collect", "Dandelion"]]
	, "Fun In The Sunflowers",
	[[1, "Collect", "Sunflower"]]
	, "Mission For Mushrooms",
	[[1, "Collect", "Mushroom"]]
	, "Leisurely Lowlands",
	[[1, "Collect", "Sunflower"]
		, [2, "Collect", "Dandelion"]
		, [3, "Collect", "Mushroom"]
		, [4, "Collect", "Blue Flower"]]
	, "Triple Trek",
	[[1, "Collect", "Mountain Top"]
		, [2, "Collect", "Pepper"]
		, [3, "Collect", "Coconut"]]
	, "Pepper Patrol",
	[[1, "Collect", "Pepper"]])


BuckoBee := Map("Abilities",
	[[1, "Collect", "Any"]]
	, "Bamboo",
	[[1, "Collect", "Bamboo"]]
	, "Bombard",
	[[4, "Get", "Ant"]
		, [3, "Get", "Ant"]
		, [2, "Kill", "RhinoBeetles"]
		, [1, "Collect", "Any"]]
	, "Booster",
	[[2, "Get", "BlueBoost"]
		, [1, "Collect", "Any"]]
	, "Clean-Up",
	[[1, "Collect", "Blue Flower"]
		, [2, "Collect", "Bamboo"]
		, [3, "Collect", "Pine Tree"]]
	, "Extraction",
	[[1, "Collect", "Clover"]
		, [2, "Collect", "Cactus"]
		, [3, "Collect", "Pumpkin"]]
	, "Flowers",
	[[1, "Collect", "Blue Flower"]]
	, "Goo",
	[[1, "Collect", "Blue"]]
	, "Medley",
	[[2, "Collect", "Bamboo"]
		, [3, "Collect", "Pine Tree"]
		, [1, "Collect", "Any"]]
	, "Picnic",
	[[5, "Get", "Ant"]
		, [4, "Get", "Ant"]
		, [3, "Feed", "Blueberry"]
		, [1, "Collect", "Blue Flower"]
		, [2, "Collect", "Blue"]]
	, "Pine Trees",
	[[1, "Collect", "Pine Tree"]]
	, "Pollen",
	[[1, "Collect", "Blue"]]
	, "Scavenge",
	[[1, "Collect", "Blue"]
		, [3, "Collect", "Blue"]
		, [2, "Collect", "Any"]]
	, "Skirmish",
	[[2, "Kill", "RhinoBeetles"]
		, [1, "Collect", "Blue Flower"]]
	, "Tango",
	[[3, "Kill", "Mantis"]
		, [1, "Collect", "Blue"]
		, [2, "Collect", "Any"]]
	, "Tour",
	[[5, "Kill", "Mantis"]
		, [4, "Kill", "RhinoBeetles"]
		, [1, "Collect", "Blue Flower"]
		, [2, "Collect", "Bamboo"]
		, [3, "Collect", "Pine Tree"]])


RileyBee := Map("Abilities",
	[[1, "Collect", "Any"]]
	, "Booster",
	[[2, "Get", "RedBoost"]
		, [1, "Collect", "Any"]]
	, "Clean-Up",
	[[1, "Collect", "Mushroom"]
		, [2, "Collect", "Strawberry"]
		, [3, "Collect", "Rose"]]
	, "Extraction",
	[[1, "Collect", "Clover"]
		, [2, "Collect", "Cactus"]
		, [3, "Collect", "Pumpkin"]]
	, "Goo",
	[[1, "Collect", "Red"]]
	, "Medley",
	[[2, "Collect", "Strawberry"]
		, [3, "Collect", "Rose"]
		, [1, "Collect", "Any"]]
	, "Mushrooms",
	[[1, "Collect", "Mushroom"]]
	, "Picnic",
	[[4, "Get", "Ant"]
		, [3, "Feed", "Strawberry"]
		, [1, "Collect", "Mushroom"]
		, [2, "Collect", "Strawberry"]]
	, "Pollen",
	[[1, "Collect", "Red"]]
	, "Rampage",
	[[3, "Get", "Ant"]
		, [2, "Kill", "Ladybugs"]
		, [1, "Kill", "All"]]
	, "Roses",
	[[1, "Collect", "Rose"]]
	, "Scavenge",
	[[1, "Collect", "Red"]
		, [3, "Collect", "Strawberry"]
		, [2, "Collect", "Any"]]
	, "Skirmish",
	[[2, "Kill", "Ladybugs"]
		, [1, "Collect", "Mushroom"]]
	, "Strawberries",
	[[1, "Collect", "Strawberry"]]
	, "Tango",
	[[3, "Kill", "Scorpions"]
		, [1, "Collect", "Red"]
		, [2, "Collect", "Any"]]
	, "Tour",
	[[5, "Kill", "Scorpions"]
		, [4, "Kill", "Ladybugs"]
		, [1, "Collect", "Mushroom"]
		, [2, "Collect", "Strawberry"]
		, [3, "Collect", "Rose"]])

QuestBarGapSize := 10
QuestBarSize := 50
QuestBarInset := 16
global QuestLadybugs := 0
global QuestRhinoBeetles := 0
global QuestSpider := 0
global QuestMantis := 0
global QuestScorpions := 0
global QuestWerewolf := 0
global BuckoRhinoBeetles := 0
global BuckoMantis := 0
global RileyLadybugs := 0
global RileyScorpions := 0
global RileyAll := 0
global PolarQuest := ""
global PolarQuestComplete := 0
global QuestGatherField := "None"

/*

Due to natros quest system being ass, this will need to be redone using ocr.

*/

PolarQuestProg() {
	global PolarQuestComplete, PolarQuest, PolarBear, QuestLadybugs, QuestRhinoBeetles, QuestSpider, QuestMantis, QuestScorpions, QuestWerewolf, TotalQuestsComplete, SessionQuestsComplete
	if (!polar)
		return
	SetShiftLock(0)
	OpenMenu("questlog")

	hwnd := GetRobloxHWND()
	offsetY := GetYOffset(hwnd)
	;search for polar quest
	Loop 70
	{
		Qfound := ImgSearch("polar_bear.png", 50, "quest")
		if (Qfound[1] = 0) {
			if (A_Index > 1)
				Gdip_DisposeImage(pBMLog)
			break
		}

		Qfound := ImgSearch("polar_bear2.png", 50, "quest")
		if (Qfound[1] = 0) {
			if (A_Index > 1)
				Gdip_DisposeImage(pBMLog)
			break
		}

		Qfound := ImgSearch("polar_bear3.png", 50, "quest")
		if (Qfound[1] = 0) {
			if (A_Index > 1)
				Gdip_DisposeImage(pBMLog)
			break
		}

		ActivateRoblox()
		switch A_Index
		{
			case 1:
				GetRobloxClientPos(hwnd)
				MouseMove windowX + 30, windowY + offsetY + 200, 5
				Loop 50 ; scroll all the way up
				{
					MouseMove windowX + 30, windowY + offsetY + 200, 5
					sendinput "{WheelUp}"
					Sleep 50
				}
				pBMLog := Gdip_BitmapFromScreen(windowX + 30 "|" windowY + offsetY + 180 "|30|400")

			default:
				GetRobloxClientPos(hwnd)
				MouseMove windowX + 30, windowY + offsetY + 200, 5
				sendinput "{WheelDown}"
				Sleep 500 ; wait for scroll to finish
				pBMScreen := Gdip_BitmapFromScreen(windowX + 30 "|" windowY + offsetY + 180 "|30|400")
				if (Gdip_ImageSearch(pBMScreen, pBMLog, , , , , , 50) = 1) { ; end of quest log
					Gdip_DisposeImage(pBMLog), Gdip_DisposeImage(pBMScreen)
					break
				}
				Gdip_DisposeImage(pBMLog), pBMLog := Gdip_CloneBitmap(pBMScreen), Gdip_DisposeImage(pBMScreen)
		}
	}
	Sleep 500

	if (Qfound[1] = 0) {
		;locate exact bottom of quest title bar coordinates
		;titlebar = 30 pixels high
		;quest objective bar spacing = 10 pixels
		;quest objective bar height = 40 pixels
		GetRobloxClientPos(hwnd)
		MouseMove windowX + 350, windowY + offsetY + 100
		xi := windowX
		yi := windowY + Qfound[3]
		ww := windowX + 306
		wh := windowY + windowHeight
		fileName := "questbargap.png"
		if DirExist(A_WorkingDir "\Assets\images\")
		{
			try result := ImageSearch(&FoundX, &FoundY, xi, yi, ww, wh, "*5 " A_WorkingDir "\Assets\images\" fileName)
			catch {
				SetStatus("Error", "Image file " filename " was not found in:`n" A_WorkingDir "\Assets\images\" fileName)
				Sleep 5000
				ProcessClose DllCall("GetCurrentProcessId")
			}
		} else {
			MsgBox "Folder location cannot be found:`n" A_WorkingDir "\Assets\images"
		}
		PolarStart := (result = 1) ? [0, FoundX - windowX, FoundY - windowY] : [1, 0, 0]
		;determine Quest name
		xi := windowX
		yi := windowY + PolarStart[3] - 30
		ww := windowX + 306
		wh := windowY + PolarStart[3]
		for key, value in PolarBear {
			filename := (key . ".png")
			try
				result := ImageSearch(&FoundX, &FoundY, xi, yi, ww, wh, "*10 Assets\Images\" fileName)
			catch
				result := 0
			if (result = 1) {
				PolarQuest := key
				questSteps := PolarBear[key].Length
				;make sure full quest is visible
				loop 5 {
					found := 0
					NextY := windowY + PolarStart[3]
					loop questSteps {
						try
							result := ImageSearch(&FoundX, &FoundY, windowX + QuestBarInset, NextY, windowX + QuestBarInset + 300, NextY + QuestBarGapSize, "*5 Assets\images\questbargap.png")
						catch
							result := 0
						if (result = 1) {
							NextY := NextY + QuestBarSize
							found := found + 1
						} else {
							break
						}
					}
					if (found < questSteps) {
						MouseMove windowX + 30, windowY + offsetY + 225
						Sleep 50
						Send "{WheelDown 1}"
						Sleep 50
						PolarStart[3] -= 150
						Sleep 500
					} else {
						break 2
					}
				}
				break
			}
		}
		;Update Polar quest progress in GUI
		;also set next steps
		QuestGatherField := "None"
		writeSettings("Quests", "QuestGatherField", "None", "settings\timers.ini")
		QuestGatherFieldSlot := 0
		newLine := "|"
		polarProgress := ""
		num := PolarBear[PolarQuest].Length
		loop num {
			action := PolarBear[PolarQuest][A_Index][2]
			where := PolarBear[PolarQuest][A_Index][3]
			questbarColor := PixelGetColor(windowX + QuestBarInset + 10, windowY + QuestBarSize * (PolarBear[PolarQuest][A_Index][1] - 1) + PolarStart[3] + QuestBarGapSize + 5)
			if ((questbarColor = 0xF46C55) || (questbarColor = 0x6EFF60)) {
				PolarQuestComplete := 0
				writeSettings("Quests", "PolarQuestComplete", PolarQuestComplete, "Settings\timers.ini")
				completeness := "Incomplete"
				if (action = "kill") {
					Quest%where% := 1
					writeSettings("Quests", "Quest" . where, Quest%where%, "settings\timers.ini")
				}
				else if (action = "collect" && QuestGatherField = "none") {
					QuestGatherField := where
					writeSettings("Quests", "QuestGatherField", QuestGatherField, "settings\timers.ini")
					QuestGatherFieldSlot := PolarBear[PolarQuest][A_Index][1]
				}
			}
			;border color, white (titlebar), black (text)
			else if ((questbarColor != 0x96C3DE) && (questbarColor != 0xE5F0F7) && (questbarColor != 0x1B2A35)) {
				completeness := "Complete"
				if (action = "kill") {
					Quest%where% := 0
				}
			} else {
				completeness := "Unknown"
			}
			if (A_Index = 1)
				polarProgress := (PolarQuest . newline . action . " " . (where = "None" ? "Any" : where) . ": " . completeness)
			else
				polarProgress := (polarProgress . newline . action . " " . (where = "None" ? "Any" : where) . ": " . completeness)
		}
		writeSettings("Quests", "PolarQuestProgress", polarProgress, "Settings\timers.ini")
		if (QuestLadybugs = 0 && QuestRhinoBeetles = 0 && QuestSpider = 0 && QuestMantis = 0 && QuestScorpions = 0 && QuestWerewolf = 0 && QuestGatherField = "None") {
			PolarQuestComplete := 1
			writeSettings("Quests", "PolarQuestComplete", PolarQuestComplete, "Settings\timers.ini")
		}
	}
}
DoPolarQuest() {
	global TotalQuestsComplete, SessionQuestsComplete, PolarQuestComplete, PolarQuest, PolarBear, QuestLadybugs, toHiveByQuest, QuestRhinoBeetles, QuestSpider, QuestMantis, QuestScorpions, QuestWerewolf, QuestGatherField
	if (!polarBear)
		return
	SetShiftLock(0)
	RotateQuest := "Polar"
	PolarQuestProg()
	if (PolarQuestComplete = 1) {
		GotoQuestgiver("polar")
		PolarQuestProg()
		if (!PolarQuestComplete) {
			SetStatus("Starting", "Polar Quest: " . PolarQuest)
			TotalQuestsComplete := TotalQuestsComplete + 1
			SessionQuestsComplete := SessionQuestsComplete + 1
			;PostSubmacroMessage("StatMonitor", 0x5555, 5, 1)
			writeSettings("Quests", "TotalQuestsComplete", TotalQuestsComplete, "Settings\timers.ini", false)
			writeSettings("Quests", "SessionQuestsComplete", SessionQuestsComplete, "Settings\timers.ini")
		}
	}
	;do quest stuff
	if (PolarQuestComplete != 1) {
		SetStatus("Starting", "Polar Quest: " . PolarQuest)
		if ((QuestLadybugs && (nowUnix() - LastLadybug) > floor(330 * (1 - (mobRespawnTime ? mobRespawnTime : 0) * 0.01))) || (QuestRhinoBeetles && (nowUnix() - LastRhinoBeetle) > floor(330 * (1 - (mobRespawnTime ? mobRespawnTime : 0) * 0.01))) || (QuestSpider && (nowUnix() - LastSpider) > floor(1830 * (1 - (mobRespawnTime ? mobRespawnTime : 0) * 0.01))) || (QuestMantis && (nowUnix() - LastMantis) > floor(1230 * (1 - (mobRespawnTime ? mobRespawnTime : 0) * 0.01))) || (QuestScorpions && (nowUnix() - LastScorpion) > floor(1230 * (1 - (mobRespawnTime ? mobRespawnTime : 0) * 0.01))) || (QuestWerewolf && (nowUnix() - LastWerewolf) > floor(3600 * (1 - (mobRespawnTime ? mobRespawnTime : 0) * 0.01)))) {
			if (QuestLadybugs == 1) {
				KillMob("Ladybug")
			}
			if (QuestRhinoBeetles == 1) {
				KillMob("RhinoBeetle")
			}
			if (QuestSpider == 1) {
				KillMob("Spider")
			}
			if (QuestMantis == 1) {
				KillMob("Mantis")
			}
			if (QuestScorpions == 1) {
				KillMob("Scorpions")
			}
			if (QuestWerewolf == 1) {
				KillMob("Werewolf")
			}
		}
		if (QuestGatherField != "None") {
			ResetToHive()
			functionName := "gt_" . StrLower(QuestGatherField)
			CurrentQuestGatherField := QuestGatherField
			switch StrLower(QuestGatherField) {
				case "pine tree": gt_pinetree()
				case "blue flower": gt_blueflower()
				case "mountain top": gt_mountaintop()
				default: %functionName%()
			}

			SetStatus("Gathering Quest", PolarQuest " - " QuestGatherField)

			Send "{" SC_1 "}"

			Loop 11 {
				send "{" RotUp " down}"
				Sleep(10 + keyDelay)
				send "{" RotUp " up}"
				Sleep(10 + keyDelay)
			}
			Loop 3 {
				send "{" RotDown " down}"
				Sleep(10 + keyDelay)
				send "{" RotDown " up}"
				Sleep(10 + keyDelay)
			}

			startTime := A_TickCount

			sharedPath := GetSharedPath() ; Get the correct path for communication files

			retryCount := 0
			maxRetries := 20  ; Try for about 1 second total
			success := false

			while (retryCount < maxRetries && !success) {
				try {
					IniWrite("true", "settings/settings.ini", "AIGather", "currently_gathering")
					LogMessage("Quest: Set gather state to 'true' in settings.ini" . (retryCount > 0 ? " (retry " . retryCount . ")" : ""))
					success := true
				} catch Error as e {
					retryCount++
					if (retryCount >= maxRetries) {
						LogMessage("Quest: CRITICAL ERROR - Failed to set gather state after " . maxRetries . " attempts over 1 second - Error: " . e.Message)
						; Continue anyway - don't let this stop the quest process
					} else {
						; Exponential backoff: 10ms, 20ms, 40ms, 80ms, etc. up to 100ms max
						sleepTime := Min(10 * (2 ** (retryCount - 1)), 100)
						Sleep(sleepTime)
					}
				}
			}
			loop {
				DisconnectCheck()
				if (BackpackPercent()) {
					if (UseSlots("Microconverter")) {
						continue
					} else {
						break
					}
				}
				if (!ActiveHoney()) {
					break
				}

				PolarQuestProg()
				if (QuestGatherField = "None" || QuestGatherField != CurrentQuestGatherField) {
					break
				}

				if ((A_TickCount - startTime) > 3 * 60000) { ; 5 minute time limit
					break
				}

				Sleep(5000)
			}

			; Clear gather state in settings.ini with robust retry logic
			retryCount := 0
			maxRetries := 20  ; Try for about 1 second total
			success := false

			while (retryCount < maxRetries && !success) {
				try {
					IniWrite("false", "settings/settings.ini", "AIGather", "currently_gathering")
					LogMessage("Quest: Set gather state to 'false' in settings.ini" . (retryCount > 0 ? " (retry " . retryCount . ")" : ""))
					success := true
				} catch Error as e {
					retryCount++
					if (retryCount >= maxRetries) {
						LogMessage("Quest: CRITICAL ERROR - Failed to clear gather state after " . maxRetries . " attempts over 1 second - Error: " . e.Message)
						; Continue anyway - Python will eventually timeout or user can manually stop
					} else {
						; Exponential backoff: 10ms, 20ms, 40ms, 80ms, etc. up to 100ms max
						sleepTime := Min(10 * (2 ** (retryCount - 1)), 100)
						Sleep(sleepTime)
					}
				}
			}

			SetStatus("Gathering Quest", "Ended")

			if (toHiveByQuest == "Walk") {
				functionName := "wf_" . StrLower(CurrentQuestGatherField)
				switch StrLower(CurrentQuestGatherField) {
					case "pine tree": wf_pinetree()
					case "blue flower": wf_blueflower()
					case "mountain top": wf_mountaintop()
					default: %functionName%()
				}
				Move(1.5, "s") ;walk backwards to avoid thicker hives
				Move(35, "d") ;walk to ramp
				Move(2.7, "s") ;center with hive pads
				findHiveSlot()
			} else {
				ResetToHive()
			}
		}
		PolarQuestProg()
		if (PolarQuestComplete) {
			gotoQuestgiver("polar")
			PolarQuestProg()
			if (!PolarQuestComplete) {
				SetStatus("Starting", "Polar Quest: " . PolarQuest)
				TotalQuestsComplete := TotalQuestsComplete + 1
				SessionQuestsComplete := SessionQuestsComplete + 1
				;PostSubmacroMessage("StatMonitor", 0x5555, 5, 1)
				writeSettings("Quests", "TotalQuestsComplete", TotalQuestsComplete, "Settings\timers.ini", false)
				writeSettings("Quests", "SessionQuestsComplete", SessionQuestsComplete, "Settings\timers.ini")
			}
		}
	}
}